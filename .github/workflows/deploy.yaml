name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Add your build and test steps here
  
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup SSH connection with domain-based health checks
      - name: Install SSH key and connect to server
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== Starting deployment for melonews.tech ==="
            echo "Domain: melonews.tech"
            echo "Server IP: 104.248.161.154"
            
          
            
            # Check git repository status
            echo "=== Git status ==="
            git status
            
            # Pull latest changes
            echo "=== Pulling latest changes ==="
            git pull origin main || echo "WARNING: git pull failed, continuing..."
            
            # Check Docker and Docker Compose availability
            echo "=== Checking Docker ==="
            docker --version
            docker-compose --version
            
            # Stop existing containers
            echo "=== Stopping existing containers ==="
            docker-compose down || echo "WARNING: docker-compose down failed, continuing..."
            
            # Build and start new containers
            echo "=== Building and starting containers ==="
            docker-compose up -d --build || echo "WARNING: docker-compose up failed, continuing..."
            
            # Check status
            echo "=== Container status ==="
            docker-compose ps
            
            # Check logs
            echo "=== Frontend logs ==="
            docker-compose logs --tail=20 frontend
            
            echo "=== Backend logs ==="
            docker-compose logs --tail=20 backend
            
            # Check application health with domain (after a short wait)
            echo "=== Health check via melonews.tech ==="
            sleep 15  # Wait for containers to start
            
            for i in {1..5}; do
              echo "Backend attempt $i/5"
              if curl -f https://melonews.tech/api/health; then
                echo "✓ Backend health check passed via domain"
                break
              elif [ $i -eq 5 ]; then
                echo "✗ Backend health check failed after 5 attempts"
                echo "Trying fallback to localhost..."
                if curl -f http://localhost:5000/api/health; then
                  echo "✓ Backend health check passed via localhost"
                else
                  echo "✗ Backend health check failed via localhost too"
                fi
              else
                echo "Backend health check failed, retrying in 10 seconds..."
                sleep 10
              fi
            done
            
            for i in {1..5}; do
              echo "Frontend attempt $i/5"
              if curl -f https://melonews.tech; then
                echo "✓ Frontend health check passed via domain"
                break
              elif [ $i -eq 5 ]; then
                echo "✗ Frontend health check failed after 5 attempts"
                echo "Trying fallback to localhost..."
                if curl -f http://localhost:3000; then
                  echo "✓ Frontend health check passed via localhost"
                else
                  echo "✗ Frontend health check failed via localhost too"
                fi
              else
                echo "Frontend health check failed, retrying in 10 seconds..."
                sleep 10
              fi
            done
            
            echo "=== Deployment completed for melonews.tech ==="
            
            # Final status check
            echo "=== Final status ==="
            docker-compose ps
